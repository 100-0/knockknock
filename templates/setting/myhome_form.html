{% extends 'base.html' %}

{% block content %}
<div class="myhome-register">
    <div>
        <div class="myhome-info">
            <p class="myhome-register__title">집 정보</p>
            <hr/>
            <form action="" onsubmit="homeRegisterHandleSubmit(event)" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <p class="myhome-register__row">
                    <label>집 이름 </label>  
                    <input class="form-input" id="myhome-register-name" name="name" type="text" maxlength="30"/>
                    <button type="button" onclick="onClickCheckHomeName()" class="myhome-register__btn">중복 확인</button>
                    <span id="myhome-register-alert"></span>
                </p>
                <p class="myhome-register__row">
                    <div class="myhome-register__row__flex_row">
                        <label>전세/월세</label>
                        <div class="myhome-info__rent-or-utility">
                            <label class="myhome-info__radio-btn"><input type="radio" name="utility_or_rent" value="전세"
                                    onclick="onSelectUtilityOrRent(event)" checked><span>전세</span></label>
                            <label class="myhome-info__radio-btn"><input id="myhome-info__rent-checked" type="radio"
                                    name="utility_or_rent" onclick="onSelectUtilityOrRent(event)" value="월세"><span>월세</span></label>
                        </div>
                    </div>
                </p>
                <p class="myhome-register__row myhome-register__row__rent myhome-register__display-none">
                    <label>월세 납부일: </label>
                    <input class="form-input" id="myhome-register-rent-month" name="rent_month" type="number"/><span>개월마다</span>
                    <input class="form-input" id="myhome-register-rent-date" name="rent_date" type="number"/><span>일</span>
                </p>
                <p class="myhome-register__row">
                    <div class="myhome-register__row__flex_row">
                        <label>공과금 납부일</label>
                        <div class="myhome-register__row__rent">
                            <div class="myhome-register__row__rent-type"><span>종류</span><input class="form-input" id="myhome-register-utility-name" name="utility_name" type="text" maxlength="30"/></div>
                            <input class="form-input" id="myhome-register-utility-month" name="utility_month" type="number"/> <span>개월마다</span>
                            <input class="form-input" id="myhome-register-utility-date" name="utility_date" type="number"/> <span>일</span>
                        </div>
                    </div>
                </p>
                <button type="submit" id="myhome-register__register-btn" class="myhome-register__btn">집 등록</button>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script>
    const home_name = document.getElementById('myhome-register-name');
    const rent_month = document.getElementById('myhome-register-rent-month');
    const rent_date = document.getElementById('myhome-register-rent-date');
    const utility_name = document.getElementById('myhome-register-utility-name');
    const utility_month = document.getElementById('myhome-register-utility-month');
    const utility_date = document.getElementById('myhome-register-utility-date');
    let check_name = "" //중복검사를 통과한 이름

    /* 전세/월세 선택*/
    const onSelectUtilityOrRent = (event) => {
        const rent_div = document.querySelector('.myhome-register__row.myhome-register__row__rent');
        if (event.target.value == "전세") {
            rent_div.classList.add('myhome-register__display-none');
        } else {
            rent_div.classList.remove('myhome-register__display-none');
        }
    }

    /* input창 제한 걸기 */
    let replaceNotInt = /[^0-9]/gi; // 숫자 아닌 정규식
    //let replaceChar = /[~!@\#$%^&*\()\-=+_'\;<>0-9\/.\`:\"\\,\[\]?|{}]/gi; // 특수문자 정규식 변수(공백 미포함)
    let replaceChar = /[~!@\#$%^&*\()\-=+_'\;<>\/.\`:\"\\,\[\]?|{}]/gi;
    //let replaceNotFullKorean = /[ㄱ-ㅎㅏ-ㅣ]/gi; // 완성형 아닌 한글 정규식
    home_name.addEventListener("keyup", (event) => {
        home_name.value = home_name.value.replace(replaceChar, "")
    })
    utility_name.addEventListener("keyup", (event) => {
        utility_name.value = utility_name.value.replace(replaceChar, "")
    })
    rent_month.addEventListener("keyup", (event) => {
        rent_month.value = rent_month.value.replace(replaceNotInt, "");
        if( rent_month.value != "" && (rent_month.value > 12 || rent_month.value < 1)) {
            rent_month.value = rent_month.value.slice(0, -1);
        }
    })
    utility_month.addEventListener("keyup", (event) => {
        utility_month.value = utility_month.value.replace(replaceNotInt, "");
        if( utility_month.value != "" && (utility_month.value > 12 || utility_month.value < 1)) {
            utility_month.value = utility_month.value.slice(0, -1);
        }
    })
    rent_date.addEventListener("keyup", (event) => {
        rent_date.value = rent_date.value.replace(replaceNotInt, "");
        if( rent_date.value != "" && (rent_date.value > 31 || rent_date.value < 1)) {
            rent_date.value = rent_date.value.slice(0, -1);
        }
    })
    utility_date.addEventListener("keyup", (event) => {
        utility_date.value = utility_date.value.replace(replaceNotInt, "");
        if( utility_date.value != "" && (utility_date.value > 31 || utility_date.value < 1)) {
            utility_date.value = utility_date.value.slice(0, -1);
        }
    })

    /*중복이름 체크*/
    const onClickCheckHomeName = async() => {
        if(home_name.value == "") return;
        const url = "../../myhome/check_homename/";
        const res = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': "application/x-www-form-urlencoded"
            },
            body: JSON.stringify({
                'home_name' : home_name.value
            })
        });
        const { is_available: is_available, input_name: input_name } = await res.json()
        checkHomeNameHandleResponse(is_available, input_name);
    }

    const checkHomeNameHandleResponse = (is_available, input_name) => {
        const alert = document.querySelector('#myhome-register-alert');
        
        if(is_available){
            alert.innerHTML=" 사용할 수 있는 이름입니다. ";
            alert.style.color="green";
            check_name = input_name;
            
            console.log(input_name);
            return;
        }
        else{
            alert.innerHTML=" 이미 사용 중인 이름입니다. ";
            alert.style.color="red";
        }
        // 중복임 =>경고
        home_name.value = "";
    }
    
    // 집 등록 클릭 시
    const homeRegisterHandleSubmit = (event) => {
        const rent_checked = document.querySelector('#myhome-info__rent-checked');
        let is_rent;
        if (rent_checked.checked) {
            is_rent = true;
        } else {
            is_rent = false;
        }

        //집이름 제외하곤 빈칸이 되어선 안됨
        if (is_rent && (rent_month.value == "" || rent_date.value == "")) { //월세 체크했는데 빈칸일 때. 전세 체크했을 땐 빈칸이어도 됨
            alert('입력하지 않은 항목이 있습니다.');
            return;
        }

        if (home_name.value == "" || utility_month.value == "" || utility_date.value == "") {
            alert('입력하지 않은 항목이 있습니다.');
            return;
        }
        
        if (home_name.value != check_name ){
            alert("집 이름 중복 확인을 먼저 해주세요.");
            return;
        }
    }

</script>
{% endblock %}